<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L.H.E.X | Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --neon: #00DFA2; --purple: #b666d2; --bg: #050505; --card: #0f0f0f; }
        body { background: var(--bg); color: #fff; font-family: 'Montserrat', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: #000; border-right: 1px solid #222; padding: 25px; display: flex; flex-direction: column; }
        .logo { font-size: 1.8rem; font-weight: 800; color: #fff; margin-bottom: 20px; text-align: center; letter-spacing: 2px; cursor: pointer; }
        .menu-item { padding: 15px; cursor: pointer; color: #888; border-radius: 6px; margin-bottom: 10px; font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: rgba(0, 223, 162, 0.1); color: var(--neon); border-left: 3px solid var(--neon); }
        .admin-tag { background: var(--purple); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; margin-left: auto; }

        .main { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #111 0%, #050505 50%); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        .card { background: var(--card); border: 1px solid #222; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .card-label { font-size: 0.75rem; color: #666; font-family: 'JetBrains Mono'; margin-bottom: 10px; text-transform: uppercase; }
        .card-val { font-size: 2.5rem; font-weight: 800; color: #fff; }
        .neon-txt { color: var(--neon); text-shadow: 0 0 15px rgba(0, 223, 162, 0.3); }

        /* INPUTS DO ADMIN */
        .admin-input { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; margin-bottom: 10px; border-radius: 6px; box-sizing: border-box; }
        .btn-action { background: var(--neon); color: #000; padding: 12px 30px; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; width: 100%; transition: 0.3s; }
        .btn-action:hover { background: #fff; }

        /* CHAT */
        .chat-box { height: 450px; background: #0a0a0a; border: 1px solid #333; border-radius: 12px; display: flex; flex-direction: column; }
        .msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .bubble { max-width: 80%; padding: 12px 18px; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; }
        .in { background: #222; align-self: flex-start; border-top-left-radius: 0; }
        .out { background: rgba(0, 223, 162, 0.1); border: 1px solid var(--neon); align-self: flex-end; border-top-right-radius: 0; color: #fff; }
        .ai-typing { font-style: italic; color: #666; font-size: 0.8rem; margin-left: 10px; display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo" onclick="location.reload()">L.H.E.X</div>
        
        <div style="margin-bottom: 30px; padding: 15px; background: #111; border-radius: 8px;">
            <div style="font-size: 0.7rem; color: #666;">USU√ÅRIO CONECTADO</div>
            <div style="font-weight: bold; color: #fff;">{{ user.name }}</div>
            {% if user.is_admin %} <div style="color: var(--purple); font-size: 0.7rem; margin-top: 5px;">‚óè ACESSO CEO</div> {% endif %}
        </div>

        <div class="menu-item active" onclick="switchTab('home', this)">üìä Vis√£o Geral</div>
        <div class="menu-item" onclick="switchTab('lazaro', this)">‚ö° Protocolo L√°zaro</div>
        <div class="menu-item" onclick="switchTab('sniper', this)">üß† Neuro-Sniper</div>
        <div class="menu-item" onclick="switchTab('nexus', this)">üîå Nexus API</div>
        
        {% if user.is_admin %}
        <div class="menu-item" onclick="switchTab('admin', this)" style="border-left-color: var(--purple);">
            üëë Gest√£o de Clientes <span class="admin-tag">CEO</span>
        </div>
        {% endif %}

        <div class="menu-item" style="margin-top: auto; color: #ff5f56;" onclick="window.location='/logout'">üö™ Sair</div>
    </div>

    <div class="main">
        
        <div id="home" class="tab-content active">
            <h2>Command Center</h2>
            <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div class="card-label">CAPITAL RECUPERADO TOTAL</div>
                    <div class="card-val neon-txt">R$ {{ "{:,.2f}".format(user.recuperado).replace(',','X').replace('.',',').replace('X','.') }}</div>
                </div>
                <div style="text-align: right;">
                    <div class="card-label">SERVIDORES</div>
                    <div style="color: var(--neon); font-weight: bold;">‚óè 100% ONLINE</div>
                </div>
            </div>
            <div class="card" style="height: 350px;"><canvas id="chart"></canvas></div>
        </div>

        <div id="lazaro" class="tab-content">
            <h2>Auditoria Forense (Upload)</h2>
            <div class="card" style="border: 2px dashed #333; text-align: center; cursor: pointer; padding: 60px;" onclick="document.getElementById('file').click()">
                <div style="font-size: 3rem; margin-bottom: 20px;">üìÇ</div>
                <h3>ARRASTE ARQUIVOS .CSV / .XLSX</h3>
                <p style="color: #666;">An√°lise autom√°tica de fluxo de caixa.</p>
                <input type="file" id="file" hidden onchange="runLazaro()">
            </div>
        </div>

        <div id="sniper" class="tab-content">
            <h2 style="color: var(--purple);">Neuro-Sniper Console</h2>
            <div class="chat-box">
                <div class="msgs" id="msgs">
                    <div class="bubble in">Sistema L.H.E.X pronto. Qual a obje√ß√£o do cliente?</div>
                </div>
                <div class="ai-typing" id="typing">L.H.E.X digitando...</div>
                <div style="padding: 15px; background: #111; display: flex; gap: 10px;">
                    <input type="text" id="chatInput" class="admin-input" placeholder="Ex: Cliente achou caro..." style="margin: 0;" onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="btn-action" style="width: auto;" onclick="sendChat()">ENVIAR</button>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-label">RAIO-X EMOCIONAL</div>
                <div id="analise-txt" style="color: #888; font-family: 'JetBrains Mono';">Aguardando dados...</div>
            </div>
        </div>

        <div id="admin" class="tab-content">
            <h2 style="color: var(--purple);">Gest√£o de Clientes (GOD MODE)</h2>
            <div class="card" style="max-width: 500px;">
                <div class="card-label">CADASTRAR NOVO CLIENTE</div>
                <input type="text" id="cli_user" class="admin-input" placeholder="Login (Ex: dr_roberto)">
                <input type="text" id="cli_pass" class="admin-input" placeholder="Senha Provis√≥ria">
                <input type="text" id="cli_name" class="admin-input" placeholder="Nome Completo (Ex: Dr. Roberto)">
                <input type="text" id="cli_niche" class="admin-input" placeholder="Nicho (Ex: Est√©tica)">
                <button class="btn-action" onclick="createClient()">CRIAR ACESSO</button>
            </div>
        </div>
        
        <div id="nexus" class="tab-content">
            <h2>Nexus API</h2>
            <div class="card">
                <div class="card-label">SUA CHAVE</div>
                <code>{{ user.api_key or 'Gere uma chave no painel admin' }}</code>
            </div>
        </div>

    </div>

    <script>
        function switchTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        // CHAT INTELIGENTE (SEM REPETI√á√ÉO)
        function sendChat() {
            const txt = document.getElementById('chatInput').value;
            if(!txt) return;
            
            document.getElementById('msgs').innerHTML += `<div class="bubble out">${txt}</div>`;
            document.getElementById('chatInput').value = '';
            document.getElementById('typing').style.display = 'block';
            document.getElementById('msgs').scrollTop = document.getElementById('msgs').scrollHeight;

            fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({msg: txt}) })
            .then(res => res.json())
            .then(data => {
                document.getElementById('typing').style.display = 'none';
                document.getElementById('analise-txt').innerText = data.analise;
                document.getElementById('msgs').innerHTML += `<div class="bubble in" style="border-left: 3px solid var(--purple)">${data.resposta}</div>`;
                document.getElementById('msgs').scrollTop = document.getElementById('msgs').scrollHeight;
            });
        }

        // L√ÅZARO
        function runLazaro() {
            alert("Iniciando varredura forense...");
            const fd = new FormData();
            fd.append('file', document.getElementById('file').files[0]);
            fetch('/run_lazaro', { method: 'POST', body: fd }).then(r=>r.json()).then(d => {
                alert(d.msg + " Valor: " + d.total);
                location.reload();
            });
        }

        // CRIAR CLIENTE (GOD MODE)
        function createClient() {
            const u = document.getElementById('cli_user').value;
            const p = document.getElementById('cli_pass').value;
            const n = document.getElementById('cli_name').value;
            const ni = document.getElementById('cli_niche').value;
            
            fetch('/create_client', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({username: u, password: p, name: n, niche: ni}) 
            })
            .then(r => r.json())
            .then(d => alert(d.msg));
        }

        // GR√ÅFICO
        new Chart(document.getElementById('chart'), {
            type: 'line',
            data: {
                labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'],
                datasets: [{ label: 'Performance', data: [12000, 19000, 15000, 25000, 32000, {{ user.recuperado }}], borderColor: '#00DFA2', backgroundColor: 'rgba(0,223,162,0.1)', fill: true }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#222' } }, y: { grid: { color: '#222' } } } }
        });
    </script>
</body>
</html>
