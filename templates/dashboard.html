<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center | L.H.E.X</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script> <style>
        :root { --neon: #00DFA2; --dark: #050505; --card: #0f0f0f; --border: #222; }
        body { background: var(--dark); color: #fff; font-family: 'Montserrat', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: #000; border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; }
        .logo-box { text-align: center; margin-bottom: 40px; cursor: pointer; opacity: 0.8; transition: 0.3s; }
        .logo-box:hover { opacity: 1; }
        .logo-box img { width: 40px; }
        
        .nav-item { padding: 14px; cursor: pointer; color: #666; border-radius: 6px; margin-bottom: 5px; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.3s; font-size: 0.85rem; }
        .nav-item:hover, .nav-item.active { background: #111; color: #fff; border-right: 3px solid var(--neon); }
        .nav-item i { width: 18px; }

        /* MAIN */
        .main { flex: 1; padding: 40px; overflow-y: auto; background: #080808; position: relative; }
        .watermark { position: fixed; bottom: 30px; right: 30px; width: 400px; opacity: 0.03; pointer-events: none; z-index: 0; }

        .tab-content { display: none; animation: fadeIn 0.4s ease; position: relative; z-index: 1; }
        .tab-content.active { display: block; }

        .card { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 30px rgba(0,0,0,0.5); }
        .card-title { font-size: 0.7rem; color: #555; font-family: 'JetBrains Mono'; margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; }
        .big-number { font-size: 2.5rem; font-weight: 800; color: #fff; }
        .neon-text { color: var(--neon); text-shadow: 0 0 20px rgba(0, 223, 162, 0.2); }

        /* CHAT SNIPER */
        .chat-interface { height: 500px; background: #0a0a0a; border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; }
        .chat-log { flex: 1; padding: 20px; overflow-y: auto; }
        .msg-bubble { background: #1a1a1a; padding: 12px 18px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem; border-left: 2px solid #333; }
        .msg-ai { border-left-color: var(--neon); background: rgba(0, 223, 162, 0.05); }
        .ai-meta { font-size: 0.7rem; color: var(--neon); margin-bottom: 5px; font-family: 'JetBrains Mono'; display: block; }

        /* SUPORTE FLUTUANTE */
        .fab-support { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: var(--neon); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #000; box-shadow: 0 0 20px rgba(0, 223, 162, 0.4); z-index: 99; transition: 0.3s; }
        .fab-support:hover { transform: scale(1.1); }
        .support-window { position: fixed; bottom: 90px; right: 30px; width: 320px; background: #111; border: 1px solid #333; padding: 20px; border-radius: 12px; display: none; z-index: 99; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }

        /* TABELA ADMIN */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #555; font-size: 0.7rem; padding: 10px; border-bottom: 1px solid #222; }
        td { padding: 15px 10px; border-bottom: 1px solid #1a1a1a; font-size: 0.85rem; color: #ccc; }
        
        .input-stark { width: 100%; background: #050505; border: 1px solid #222; padding: 12px; color: #fff; margin-bottom: 10px; border-radius: 4px; }
        .btn-stark { width: 100%; background: var(--neon); color: #000; border: none; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <img src="/static/logo.png" class="watermark">

    <div class="sidebar">
        <div class="logo-box" onclick="location.reload()">
            <img src="/static/logo.png">
        </div>
        
        <div style="padding: 0 10px 30px 10px;">
            <div style="font-size: 0.65rem; color: #444; letter-spacing: 1px;">OPERADOR</div>
            <div style="font-weight: 700;">{{ user.name }}</div>
        </div>

        <div class="nav-item active" onclick="tab('home', this)"><i data-lucide="layout-dashboard"></i> Visão Geral</div>
        <div class="nav-item" onclick="tab('lazaro', this)"><i data-lucide="file-search"></i> Auditoria Lázaro</div>
        <div class="nav-item" onclick="tab('sniper', this)"><i data-lucide="cpu"></i> Neuro-Sniper AI</div>
        <div class="nav-item" onclick="tab('nexus', this)"><i data-lucide="network"></i> Conexões API</div>
        
        {% if user.is_admin %}
        <div class="nav-item" onclick="tab('admin', this)" style="color: #b666d2;">
            <i data-lucide="shield-alert"></i> Gestão CEO
        </div>
        {% endif %}

        <div class="nav-item" style="margin-top: auto; color: #ff5f56;" onclick="window.location='/logout'">
            <i data-lucide="log-out"></i> Encerrar
        </div>
    </div>

    <div class="main">
        <div id="home" class="tab-content active">
            <h2 style="font-weight: 300; letter-spacing: 3px; margin-bottom: 30px;">COMMAND CENTER</h2>
            <div style="display: flex; gap: 20px;">
                <div class="card" style="flex: 1;">
                    <div class="card-title">CAPITAL RECUPERADO</div>
                    <div class="big-number neon-text">R$ {{ "{:,.2f}".format(user.recuperado).replace(',','X').replace('.',',').replace('X','.') }}</div>
                </div>
                <div class="card" style="flex: 1;">
                    <div class="card-title">STATUS DO SISTEMA</div>
                    <div style="color: var(--neon); font-weight: bold; display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <i data-lucide="activity"></i> OPERACIONAL
                    </div>
                </div>
            </div>
            <div class="card" style="height: 400px;"><canvas id="chart"></canvas></div>
        </div>

        <div id="lazaro" class="tab-content">
            <h2 style="font-weight: 300; letter-spacing: 3px;">AUDITORIA FORENSE</h2>
            <div class="card" style="text-align: center; padding: 80px; border-style: dashed; cursor: pointer;" onclick="document.getElementById('file').click()">
                <i data-lucide="upload-cloud" style="width: 50px; height: 50px; color: #333; margin-bottom: 20px;"></i>
                <h3 style="margin: 0;">UPLOAD DE DADOS</h3>
                <p style="color: #555; font-size: 0.8rem;">Protocolos Suportados: OFX, CSV, XLSX</p>
                <input type="file" id="file" hidden onchange="runLazaro()">
            </div>
        </div>

        <div id="sniper" class="tab-content">
            <h2 style="font-weight: 300; letter-spacing: 3px; color: #b666d2;">NEURO-SNIPER CORE</h2>
            <div class="chat-interface">
                <div id="chatLog" class="chat-log">
                    <div class="msg-bubble msg-ai">Sistema Conectado. Aguardando input do operador.</div>
                </div>
                <div style="padding: 20px; background: #111; border-top: 1px solid #222; display: flex; gap: 10px;">
                    <input type="text" id="chatInput" class="input-stark" placeholder="Digite a mensagem do cliente..." style="margin: 0;" onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="btn-stark" style="width: auto; padding: 0 40px;" onclick="sendChat()">PROCESSAR</button>
                </div>
            </div>
        </div>

        <div id="admin" class="tab-content">
            <h2 style="color: #b666d2;">GESTÃO EXECUTIVA</h2>
            
            <div class="card">
                <div class="card-title">CARTEIRA DE CLIENTES</div>
                <table>
                    <thead><tr><th>CLIENTE</th><th>EMAIL</th><th>RECUPERADO</th><th>AÇÃO</th></tr></thead>
                    <tbody>
                        {% for cli in clientes %}
                        <tr>
                            <td><b>{{ cli.name }}</b><br><span style="font-size:0.7rem; color:#555">{{ cli.username }}</span></td>
                            <td>{{ cli.email }}</td>
                            <td>R$ {{ "{:,.2f}".format(cli.recuperado) }}</td>
                            <td><i data-lucide="trash-2" style="width: 16px; color: #ff5f56; cursor: pointer;" onclick="delClient({{ cli.id }})"></i></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card" style="max-width: 400px;">
                <div class="card-title">NOVO CONTRATO</div>
                <input type="text" id="n_user" class="input-stark" placeholder="Login">
                <input type="text" id="n_pass" class="input-stark" placeholder="Senha">
                <input type="text" id="n_name" class="input-stark" placeholder="Nome">
                <input type="text" id="n_niche" class="input-stark" placeholder="Nicho">
                <input type="email" id="n_email" class="input-stark" placeholder="Email">
                <button class="btn-stark" onclick="createClient()">ATIVAR CONTRATO</button>
            </div>
        </div>
    </div>

    <div class="fab-support" onclick="toggleSupport()"><i data-lucide="life-buoy"></i></div>
    <div class="support-window" id="supWin">
        <h4 style="margin: 0 0 15px 0;">Suporte Prioritário</h4>
        <textarea id="supMsg" class="input-stark" style="height: 100px; resize: none;" placeholder="Descreva a solicitação..."></textarea>
        <button class="btn-stark" onclick="sendTicket()">ABRIR CHAMADO</button>
    </div>

    <script>
        lucide.createIcons();

        function tab(id, el) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        function sendChat() {
            const txt = document.getElementById('chatInput').value;
            if(!txt) return;
            const log = document.getElementById('chatLog');
            log.innerHTML += `<div class="msg-bubble">${txt}</div>`;
            document.getElementById('chatInput').value = '';
            
            fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({msg: txt}) })
            .then(r => r.json()).then(d => {
                log.innerHTML += `<div class="msg-bubble msg-ai"><span class="ai-meta">${d.analise}</span>${d.resposta}</div>`;
                log.scrollTop = 9999;
            });
        }

        function toggleSupport() {
            const w = document.getElementById('supWin');
            w.style.display = w.style.display === 'block' ? 'none' : 'block';
        }

        function sendTicket() {
            const msg = document.getElementById('supMsg').value;
            fetch('/send_support', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({msg:msg})})
            .then(() => { alert('Chamado prioritário enviado à CEO.'); toggleSupport(); });
        }

        function createClient() {
            const body = {
                username: document.getElementById('n_user').value,
                password: document.getElementById('n_pass').value,
                name: document.getElementById('n_name').value,
                niche: document.getElementById('n_niche').value,
                email: document.getElementById('n_email').value
            };
            fetch('/create_client', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) })
            .then(r => r.json()).then(d => { alert(d.msg); location.reload(); });
        }

        function delClient(id) {
            if(confirm('Confirmar exclusão?')) fetch('/delete_client/'+id, { method: 'POST' }).then(() => location.reload());
        }

        function runLazaro() {
            const fd = new FormData();
            fd.append('file', document.getElementById('file').files[0]);
            fetch('/run_lazaro', { method: 'POST', body: fd }).then(r=>r.json()).then(d => { alert(d.msg + " Valor: " + d.total); location.reload(); });
        }

        new Chart(document.getElementById('chart'), {
            type: 'line',
            data: { labels: ['S', 'T', 'Q', 'Q', 'S', 'S'], datasets: [{ label: 'Recuperado', data: [10000, 22000, 18000, 35000, 42000, {{ user.recuperado }}], borderColor: '#00DFA2', backgroundColor: 'rgba(0,223,162,0.05)', fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#1a1a1a' } }, y: { grid: { color: '#1a1a1a' } } } }
        });
    </script>
</body>
</html>
